---
format:
  html:
    toc: true
    standalone: false
    title-block-style: none
  pdf: default
  docx: default
engine: knitr
---

```{r}
#| label: setup
#| echo: false
#| warning: false
#| message: false
#| output: false

library(tidyverse)
library(here)
library(kableExtra)
library(readxl)
library(glue)
library(viridis)
source("smelt_data_extraction.R")
source("smelt_functions.R")
source("smelt_vars.R")
```

## PRELIMINARY DATA: Assessment for Delta Operations on ESA and CESA-listed Osmerids

*BDO Science Division*

Last updated: *`r format(Sys.Date(), "%B %d, %Y")`*

### Executive Summary

Section 3.13.3.4.1 of the Proposed Action and Section 8.1.4. of the Incidental Take Permit provide that during Old and Middle River (OMR) Management, the California Department of Water Resources, in coordination with Reclamation, shall provide State Water Project (SWP) and Central Valley Project (CVP) operational outlooks and assessments on a weekly basis to Water Operations Management Team (WOMT).

```{r}
narrative_text
```



### Operational and Regulatory Conditions

- See current Weekly Fish and Water Operations Outlook document.
- Additional information also available on the [SacPAS SMT page](https://www.cbr.washington.edu/sacramento/workgroups/delta_smelt.html).

### Evaluation

#### Delta Smelt

##### Current Status 

- **Delta Smelt Life Stages**: `r lifestages`

- The **abundance estimate** as of the week of `r abundance_date` was: `r paste0(abundance, " (95% CL: ", abundance_lcl, " to ", abundance_ucl, ")")`
- Detections: 
  - A total of `r adults_placeholder` (`r marked` marked and `r unmarked` unmarked) adult Delta Smelt have been detected this water year. 
  - The most recent detection(s) of `r last_catch_count` Delta Smelt occurred on `r format(last_catch_date, "%b %d, %Y")` in `r last_catch_location`
  - Delta Smelt Salvage totals `r ds_salvage_count` Delta Smelt, and the cumulative seasonal salvage is `r ds_cumsalvage`
  
###### Context

- Since there are few recent detections of Delta Smelt, the Smelt Monitoring Teamâ€™s capacity to estimate where they are within the Delta is limited. 
- A total of `r format(total_released, scientific = FALSE, big.mark = ",")` hatchery Delta Smelt have been released for WY 2026 (Table 1). The most recent releases of `r format(last_release_count, scientific = FALSE, big.mark = ",")` fish occurred in `r format(last_release_location, scientific = FALSE, big.mark = ",")` on `r format(last_release_date, "%b %d, %Y")`.
- Historical salvage trends can be found at: [SacPAS Salvage Timing](https://www.cbr.washington.edu/sacramento/data/query_salvage_hrt.html)

###### Table 1. Release Summary
Is release table able to be made public yet? 
```{r}

```

###### Figure 1. Distribution
We might have a switch between when it's adult vs juvenile season
```{r, echo = FALSE}
#| fig-width: 8
#| fig-height: 7
(map_detections_lj <- ggplot() + 
    geom_sf(data = WW_Delta, color = "darkslategray3") +
    geom_sf(data = R_EDSM_Strata_1718P1, aes(fill = Stratum), alpha = 0.4,inherit.aes = FALSE)+
    # geom_sf(data = releases_sf, shape = 23, size =3,  fill = "red", color = "black", inherit.aes = FALSE) + 
    geom_sf(data = larjuv_dataset, aes(shape = source, size = total_catch),   inherit.aes = FALSE) + 
    # geom_sf_text(data = sls_sf, mapping = aes(label = Station), size = 3, nudge_x = -0.012, nudge_y = 0.016) +
    annotation_north_arrow(location = "tl", which_north = "true",
                           pad_x = unit(.1, "in"), pad_y = unit(0.2, "in"),
                           style = north_arrow_fancy_orienteering) +
    annotation_scale(location = "bl", bar_cols = c("black", "white", "black", "white")) +
    scale_x_continuous(limits = c(-122.35, -121.3)) + 
    scale_y_continuous(limits = c(37.8, 38.6)) +
    scale_shape_manual(values = c(15, 17, 4))+
    scale_size(range = c(2, 2), breaks = c(1,1)) + 
    viridis::scale_fill_viridis(option = "turbo", discrete = TRUE) + 
    guides(fill = guide_legend(nrow = 3, byrow = TRUE)) +
    theme_bw() +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text = element_text(size = 10),
          axis.text.x = element_text(angle = 45, vjust = 0.5),
          legend.position = "top",
          legend.box = "vertical",
          legend.title = element_blank(),
          legend.text = element_text(size = 9)))
```

###### Table 2. Total Catch by survey
```{r, echo = FALSE}
kable(
  larjuv_detail %>%
  group_by(source, region, life_stage) %>%
    summarize(total = sum(catch)) %>%
    ungroup()
)
```

###### Figure 2. Plot of catch over time? 
```{r, echo = FALSE}
ggplot(larjuv_dataset) +
  geom_col(aes(date, total_catch, fill = source)) +
  scale_fill_viridis(option = "turbo", discrete = TRUE) +
  theme_bw() +
  scale_x_date()
```

##### Environmental Surrogates

- Relevant environmental conditions:

###### First Flush
```{r, echo = FALSE, results='asis'}
if (first_flush_status != "relevant") {
  cat("- Not relevant\n")
} else {
  cat(glue("
- FPT Flow (3-day average): {FPT_flow_avg} cfs as of {format(env_last_date, '%b %d, %Y')}
- FPT Turbidity (3-day average): {FPT_turb_avg} FNU as of {format(env_last_date, '%b %d, %Y')}
"))
}
```


###### Adult Entrainment (Turbidity Bridge) 

```{r, echo = FALSE, results='asis'}
if (adult_ent_status != "relevant") {
  cat("- Not relevant\n")
} else {
  cat(glue("
- **OBI Turbidity**: {paste(OBI_turb, collapse = ', ')} FNU as of {format(env_last_date, '%b %d, %Y')}
- **HOL Turbidity**: {paste(HOL_turb, collapse = ', ')} FNU as of {format(env_last_date, '%b %d, %Y')}
- **OSJ Turbidity**: {paste(OSJ_turb, collapse = ', ')} FNU as of {format(env_last_date, '%b %d, %Y')}
- Let's link to the plot on the other SacPAS SMT page. Could include some text if we want.
"))
}
```

###### Larval/Juvenile Entrainment 

```{r, echo = FALSE, results='asis'}
if (larval_ent_status != "relevant") {
  cat("- Not relevant\n")
} else {
  cat(glue("
  - RVB temperature:
  - SJJ temperature (in the future): 
  - **South Delta Secchi Depth**: The most recent average secchi depth was {sd_secchi_depth}m as of {format(sd_secchi_date, '%b %d, %Y')}
"))
}
```

###### End of OMR Management
```{r, echo = FALSE, results='asis'}
if (end_of_season != "relevant") {
  cat("- Not relevant\n")
} else {
  cat(glue("
- Clifton Court Temperature: {paste(CLC_temp, collapse = ', ')} degC as of {format(env_last_date, '%b %d, %Y')}
"))
}
```

  
###### Zone of Influence/PTM: 

### References



